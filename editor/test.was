
//array<entity_handle_t> spawn_points(512);


void OnMapEnter()
{
	array<entity_handle_t> world_entities;
	int i;
	int c;
	int j;

	world_AddWorldArrayVar("alive entities", 128, typeof<entity_handle_t>());
	world_AddWorldArrayVar("spawn points", 512, typeof<entity_handle_t>());
	world_AddWorldVar("respawn timer", typeof<int>());
	world_AddWorldVar("wave index", typeof<int>());

	world_SetWorldVarValue("respawn timer", 300);
	world_SetWorldVarValue("wave index", 0);


	//sound_handle_t music = sound_GetSound("music");
	//sound_PlaySound(music, vec3_t(0.0, 0.0, 0.0), 1.0, 1);

	//int spawn_point_count = 0;


	//world_ClearWorldArrayVar("spawn points");



	world_entities = world_GetEntities();
	c = world_entities.count;

	//spawn_points.Clear();

	world_ClearWorldArrayVar("spawn points");

	for(i = 0; i < world_entities.count; i++)
	{
        if(entity_EntityHasProp(world_entities[i], "spawn point") != 0)
		{
			//spawn_points.Append(world_entities[i]);
			world_AppendWorldArrayVarValue("spawn points", world_entities[i]);
		}
	}

	script_Print("enter map\n");

}


void enumerate_spawn_points()
{
	array<entity_handle_t> world_entities;
	int i;
	int c;

	world_entities = world_GetEntities();
	c = world_entities.count;

	world_ClearWorldArrayVar("spawn points");

	for(i = 0; i < c; i++)
	{
        if(entity_EntityHasProp(world_entities[i], "spawn point") != 0)
		{
			world_AppendWorldArrayVarValue("spawn points", world_entities[i]);
		}
	}
}



void OnMapUpdate()
{
	//script_Print(world_entities.count);
	entity_handle_t entity;
	int i;
	int c;
	int spawn_count;
	int alive_entities = 0;
	int spawn_point_count;
	int spawn_point_index;

	mat3_t entity_orientation;
	vec3_t spawn_position;
	entity_handle_t spawned;
	entity_handle_t spawn_point;
	entity_handle_t enemy_def;


	int spawn_timer;
	int wave_index;

	int x;
	int z;

	spawn_point_count = world_GetWorldArrayVarLength("spawn points");

	if(spawn_point_count > 0)
	{
		world_GetWorldVarValue("respawn timer", spawn_timer);

		if(spawn_timer > 0)
		{
			spawn_timer--;
			world_SetWorldVarValue("respawn timer", spawn_timer);
		}
		else if(spawn_timer == 0)
		{
			spawn_timer = -1;
			world_SetWorldVarValue("respawn timer", spawn_timer);

			world_GetWorldVarValue("wave index", wave_index);

			switch(wave_index)
			{
				case 0:
					spawn_count = 10;
				break;

				case 1:
					spawn_count = 50;
				break;

				case 2:
					spawn_count = 100;
				break;

				case 3:
					spawn_count = 150;
				break;

				default:
					spawn_count = 250;
				break;

			}

			//enumerate_spawn_points();

			world_ClearWorldArrayVar("alive entities");
			enemy_def = entity_GetEntity("enemy entity", 1);
			entity_orientation.identity();

			script_Print("FUCK!\n");

			for(i = 0; i < spawn_count; i++)
			{
				spawn_point_index = rand() % spawn_point_count;

				world_GetWorldArrayVarValue("spawn points", spawn_point_index, spawn_point);

				//

				spawn_position = entity_GetEntityPosition(spawn_point, 0);

				spawn_position.x += (randfloat() * 2.0 - 1.0) * 3.0;
				//spawn_position.y += (randfloat() * 2.0 - 1.0) * 3.0;
				//spawn_position.y += 10.0;
				spawn_position.z += (randfloat() * 2.0 - 1.0) * 3.0;


				//spawned = entity_SpawnEntity(entity_orientation, vec3_t(-5.0 + x, 3.0, (-z / 2) + z * 2), vec3_t(1.0, 1.0, 1.0), enemy_def, "enemy");
				spawned = entity_SpawnEntity(entity_orientation, spawn_position, vec3_t(1.0, 1.0, 1.0), enemy_def, "enemy");
				entity_SetEntityVelocity(spawned, vec3_t(0.0, 0.0, 0.0));
				world_AppendWorldArrayVarValue("alive entities", spawned);
			}
		}
		else if(spawn_timer < 0)
		{
			c = world_GetWorldArrayVarLength("alive entities");
			alive_entities = 0;

			for(i = 0; i < c; i++)
			{
				world_GetWorldArrayVarValue("alive entities", i, spawned);

				if(entity_IsEntityValid(spawned) != 0)
				{
					alive_entities++;
				}

			}

			if(alive_entities == 0)
			{
				world_SetWorldVarValue("respawn timer", 300);

				world_GetWorldVarValue("wave index", wave_index);
				wave_index++;
				world_SetWorldVarValue("wave index", wave_index);
			}
		}
	}




}



